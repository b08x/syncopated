---
# tasks file for tuning

- name: RT Tasks
  ansible.builtin.debug:
    msg: "Starting RT tasks"

- name: Collect only selected facts
  ansible.builtin.setup:
    filter:
    - ansible_system_vendor

- name: Install Tuning packages
  block:
    - name: Install main Tuning packages
      when: ansible_distribution == "Fedora"


        # - name: Install additional Tuning packages
        #   package:
        #     name: "{{ additional_tuning_packages[ansible_distribution | lower] }}"
        #     state: present
        #
        # - name: Install optional Tuning packages
        #   package:
        #     name: "{{ optional_tuning_packages[ansible_distribution | lower] }}"
        #     state: present
        #   when: install_optional_tuning_packages | default(false) | bool

      ansible.builtin.package:
        name: "{{ tuning_packages[ansible_distribution | lower] }}"
        state: present

- name: Handle missing packages
  block:
    - name: Warn about missing rtirq on Fedora
      when: ansible_distribution == "Fedora"
      ansible.builtin.debug:
        msg: "rtirq is not available in Fedora repositories. Consider finding an alternative or installing from source."

    - name: Warn about missing bpftune on Fedora
      debug:
        msg: "bpftune is not available in Fedora repositories. Consider finding an alternative or installing from source."
      when: ansible_distribution == "Fedora"

  when: ansible_distribution == "Fedora"

- name: Ensure tuned profile directory exists
  become: true
  ansible.builtin.file:
    path: /etc/tuned/realtime-modified
    state: directory
    mode: '0755'

- name: Ensure utillity config folders exist
  loop:
  - /etc/security/limits.d
  - /etc/sysctl.d
  - /etc/tuned/realtime-modified
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory

- name: Ensure user belongs to audio group
  ansible.builtin.user:
    name: "{{ user.name }}"
    groups: "audio"
    append: true

- name: Set rtprio, memlock and nice for audio group
  ignore_errors: "{{ ansible_check_mode }}"
  when: tune_for_realtime == True


# It is safe to have this file even if
# your hardware contains neither device
# source: https://gentoostudio.org/?page_id=420
  ansible.builtin.copy:
    content: |
      @audio  - rtprio  98
      @audio  - nice    -19
      @audio  - memlock unlimited
    dest: "/etc/security/limits.d/99-realtime.conf"
    mode: '0644'
    backup: true

- name: Set timer permissions in udev rules
  ansible.builtin.copy:
    content: |
      KERNEL=="rtc0", GROUP="audio"
      KERNEL=="hpet", GROUP="audio"
    dest: "/etc/udev/rules.d/40-timer-permissions.rules"
    mode: '0644'

- name: Set sysctl parameters
  tags:
  - sysctl
  ansible.builtin.copy:
    src: etc/sysctl.d/99-cachyos-settings.conf
    dest: /etc/sysctl.d/99-cachyos-settings.conf
    mode: '0644'
    backup: true

- ansible.builtin.import_tasks: cpupower.yml

- ansible.builtin.import_tasks: rtkit.yml

- import_tasks: tuned.yml
