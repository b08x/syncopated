---

- name: install nginx dependencies
  with_items:
  - git
  - '@Development Tools'
  - pcre2-devel
  - pcre-devel
  when: ansible_distribution == 'Fedora'
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: present
    update_cache: true

- name: install nginx dependencies
  with_items:
  - base-devel
  - git
  - pcre
  - pcre2
  when: ansible_os_family == 'Archlinux'
  community.general.pacman:
    name: "{{ item }}"
    state: present
    force: true
    extra_args: --noconfirm

- name: fetch nginx source
  ansible.builtin.get_url:
    url: http://nginx.org/download/nginx-1.22.1.tar.gz
    dest: "/tmp"
    validate_certs: false

- name: extract nginx source
  ansible.builtin.unarchive:
    src: /tmp/nginx-1.22.1.tar.gz
    dest: "/tmp"
    remote_src: true

- name: clone fancyindex
  ansible.builtin.git:
    repo: "https://github.com/aperezdc/ngx-fancyindex.git"
    dest: "/tmp/ngx-fancyindex"
    accept_hostkey: true
    update: false
    force: false
    recursive: true

- name: configure nginx with modules
  args:
    chdir: /tmp/nginx-1.22.1
  ansible.builtin.shell: |
    ./configure --prefix=/usr --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --pid-path=/run/nginx.pid --conf-path=/etc/nginx/nginx.conf --modules-path=/usr/share/nginx/modules --add-module=../ngx-fancyindex --with-http_addition_module --with-http_mp4_module --without-http_autoindex_module --without-http_gzip_module

- name: make and install nginx
  args:
    chdir: /tmp/nginx-1.22.1
  ansible.builtin.shell: |
    make && make install
