---

- name: Set autofs config folder
  when: ansible_distribution == 'Fedora' or ansible_distribution == 'Debian'
  ansible.builtin.set_fact:
    _autofs_dir: /etc

- name: Set autofs config folder
  when: ansible_os_family == 'Archlinux'

# - block:
#     - name: Install autofs
#       apt:
#         name: autofs
#         state: present
#       when: ansible_distribution == 'Debian'
#
#     - name: Install autofs
#       dnf:
#         name: autofs
#         state: present
#         update_cache: yes
#       when: ansible_distribution == 'Fedora'
#
#     - name: Install autofs
#       aur:
#         use: auto
#         name: autofs
#         state: present
#       become: False
#       when: ansible_os_family == 'Archlinux'
#
#   tags: ['packages']
  ansible.builtin.set_fact:
    _autofs_dir: /etc/autofs

- block:
    - name: Create mount directory folder if it doesn't already exist
      ansible.builtin.file:
        path: /mnt/{{ autofs_client.host }}
        state: directory
        mode: '0755'

    - name: Install autofs configs
      with_items:
      - autofs.conf
      - auto.master
      - auto.mnt
      register: autofsconfig
      ansible.builtin.template:
        src: etc/autofs/{{ item }}.j2
        dest: "{{ _autofs_dir }}/{{ item }}"
        mode: '0644'
        backup: true

    - name: Enable autofs service
      ignore_errors: "{{ ansible_check_mode }}"
      ansible.builtin.systemd:
        name: autofs
        enabled: true
